{% extends 'base_logged_in.html' %}
{% block title %}Your Cart{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <h2 class="text-center mb-4">üõí Your Cart</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} text-center">{{ message }}</div>
        {% endfor %}
    {% endif %}

    {% if cart_items %}
        <div class="alert alert-success text-center">
            üõçÔ∏è Order the first item in your cart now and get <strong>5% off</strong>!
        </div>

        <form method="POST" action="{% url 'place_order' %}" class="mt-4">
            {% csrf_token %}
            <ul class="list-group">
                {% for item in cart_items %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start flex-wrap">
                            <div class="flex-grow-1">
                                <input type="checkbox" name="selected_items" value="{{ item.food.food_id }}" onchange="updateTotal()" class="me-2">
                                <strong>{{ item.food.name }}</strong> (x{{ item.quantity }})
                                <p class="mb-1"><small class="text-muted">Restaurant: {{ item.food.restaurant.name }}</small></p>
                                <div class="btn-group btn-group-sm mb-2" role="group">
                                    <form method="POST" action="{% url 'add_to_cart' item.food.food_id %}" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="quantity" value="1">
                                        <button type="submit" class="btn btn-success">+</button>
                                    </form>
                                    <form method="POST" action="{% url 'remove_from_cart' item.food.food_id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-warning">-</button>
                                    </form>
                                    <form method="POST" action="{% url 'delete_from_cart' item.food.food_id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger">Delete</button>
                                    </form>
                                </div>
                                {% if forloop.first %}
                                    <div><small class="text-info">üí° Select it and click <strong>‚Äú+‚Äù</strong> to order directly and get the offer!</small></div>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <span class="item-price fs-5 fw-semibold">${{ item.food.price|floatformat:2 }}</span>
                                <input type="hidden" class="item-quantity" value="{{ item.quantity }}">
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>

            <div class="mt-4">
                <h4 class="text-end">Total: $<span id="totalPrice">0.00</span></h4>
            </div>

            {% if delivery_addresses %}
                <div class="form-group mt-4">
                    <label for="delivery_address" class="form-label fw-semibold">Select Delivery Address:</label>
                    <select class="form-control" id="delivery_address" name="delivery_address" required>
                        {% for address in delivery_addresses %}
                            <option value="{{ address.address_id }}">{{ address.address }}, {{ address.city }}, {{ address.state }}, {{ address.zip_code }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}

            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary btn-lg" onclick="handlePlaceOrderClick()">Place Order</button>
                <span id="noSelectionMsg" class="text-danger mt-2 d-block" style="display:none;">Please select at least one item before placing an order.</span>
            </div>
        </form>
    {% else %}
        <p class="text-center mt-5">Your cart is empty.</p>
    {% endif %}
</div>

<!-- Order Summary Modal -->
<div class="modal fade" id="orderSummaryModal" tabindex="-1" role="dialog" aria-labelledby="orderSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content shadow-lg rounded-4">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Order Summary</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-2">Restaurant: <span id="restaurantName" class="fw-semibold">Loading...</span></h6>
                <ul id="orderItems" class="list-unstyled mb-3"></ul>
                <h6>Total Amount: $<span id="modalTotalPrice">0.00</span></h6>
                <div class="form-group mt-3">
                    <label for="card-element" class="form-label">Credit or Debit Card</label>
                    <input type="text" id="card-element" class="form-control" placeholder="Enter card number">
                    <div id="card-errors" class="text-danger mt-1 small"></div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="submitPayment">‚úÖ Confirm Order</button>
            </div>
        </div>
    </div>
</div>

<script>
    function updateTotal() {
        let total = 0;
        document.querySelectorAll('input[name="selected_items"]:checked').forEach(checkbox => {
            const item = checkbox.closest('li');
            const price = parseFloat(item.querySelector('.item-price').textContent.replace('$', ''));
            const quantity = parseInt(item.querySelector('.item-quantity').value);
            total += price * quantity;
        });
        document.getElementById('totalPrice').textContent = total.toFixed(2);
        document.getElementById('modalTotalPrice').textContent = total.toFixed(2);
    }

    function updateOrderSummary() {
        const checkboxes = document.querySelectorAll('input[name="selected_items"]:checked');
        const orderItemsList = document.getElementById('orderItems');
        orderItemsList.innerHTML = '';
        let restaurantName = '';

        checkboxes.forEach(checkbox => {
            const item = checkbox.closest('li');
            const name = item.querySelector('strong').textContent;
            const quantity = item.querySelector('.item-quantity').value;
            const price = item.querySelector('.item-price').textContent;
            restaurantName = item.querySelector('p').textContent.replace('Restaurant: ', '');

            const listItem = document.createElement('li');
            listItem.textContent = `${name} (x${quantity}) - ${price}`;
            orderItemsList.appendChild(listItem);
        });

        document.getElementById('restaurantName').textContent = restaurantName;
    }

    function handlePlaceOrderClick() {
        const selected = document.querySelectorAll('input[name="selected_items"]:checked');
        const msg = document.getElementById('noSelectionMsg');

        if (selected.length === 0) {
            msg.style.display = 'block';
        } else {
            msg.style.display = 'none';
            updateOrderSummary();
            $('#orderSummaryModal').modal('show');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateTotal();

        document.querySelectorAll('input[name="selected_items"]').forEach(cb => {
            cb.addEventListener('change', () => {
                updateTotal();
                updateOrderSummary();
                document.getElementById('noSelectionMsg').style.display = 'none';
            });
        });

        // Update "+" button AJAX reload
        document.querySelectorAll('form[d-inline] button[type="submit"]').forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();
                const form = button.closest('form');
                const formData = new FormData(form);

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            window.location.reload();
                        } else {
                            console.error('Error:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        });
    });

    document.getElementById("submitPayment").addEventListener("click", function () {
        const cardInput = document.getElementById("card-element").value.trim();
        const selectedItems = Array.from(document.querySelectorAll('input[name="selected_items"]:checked')).map(cb => cb.value);

        if (selectedItems.length === 0) {
            alert("Please select at least one item.");
            return;
        }

        if (!cardInput) {
            document.getElementById("card-errors").textContent = "Please enter your card information.";
            return;
        }

        document.getElementById("card-errors").textContent = "";

        fetch('/place_order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                selected_items: selectedItems,
                card_number: cardInput
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert("Order confirmed. Enjoy your food!");
                    window.location.reload();
                } else {
                    console.error('Error:', data.message);
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });

        $('#orderSummaryModal').modal('hide');
    });
</script>
{% endblock %}
