{% extends 'base_logged_in.html' %}
{% load static %}

{% block title %}Menu - {{ restaurant.name }}{% endblock %}

{% block content %}
<style>
  body {
    padding-top: 90px;
  }

  /* Fade-in animation */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .animated-fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }

  /* Slide-up animation */
  @keyframes slideUp {
    from { transform: translateY(20px); }
    to { transform: translateY(0); }
  }

  .animated-slide-up {
    animation: slideUp 0.5s ease-out forwards;
  }

  /* Transition for interactive elements */
  .btn {
    transition: background-color 0.3s ease, transform 0.2s ease;
  }

  .btn:hover {
    transform: scale(1.05);
  }

  /* Card hover effect */
  .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }

  /* Star Rating Styles */
  .star-rating {
    direction: rtl;
    display: inline-block;
    font-size: 20px;
  }

  .star-rating input {
    display: none;
  }

  .star-rating label {
    color: #ccc;
    cursor: pointer;
    transition: color 0.2s;
  }

  .star-rating input:checked ~ label,
  .star-rating :hover input ~ label {
    color: #ffc107;
  }

  .star-rating label:hover,
  .star-rating label:hover ~ label {
    color: #ffc107;
  }

  /* Position the "See Reviews" button */
  .see-reviews-btn {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 1000;
  }

  /* Modal styles */
  .modal-dialog {
    position: fixed;
    right: 0;
    margin: 0;
    width: 400px;
    height: 100%;
    max-width: none;
  }

  .modal-content {
    height: 100%;
    overflow-y: auto;
  }

  .review {
    border-bottom: 1px solid #eee;
    padding: 15px 0;
    display: flex;
    flex-direction: column;
  }

  .review-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }

  .review-rating {
    color: #ffc107;
    margin-right: 10px;
  }

  .review-author {
    font-weight: bold;
    margin-right: 10px;
  }

  .review-date {
    color: #6c757d;
    font-size: 0.9em;
  }

  .review-text {
    margin-top: 10px;
  }

  .review-actions {
    display: flex;
    align-items: center;
    margin-top: 10px;
  }

  .review-actions a {
    color: #6c757d;
    margin-right: 15px;
    text-decoration: none;
  }

  .review-actions a:hover {
    text-decoration: underline;
  }
</style>

<div class="container">
  <!-- See Reviews Button -->
  <button type="button" class="btn btn-info see-reviews-btn" data-toggle="modal" data-target="#reviewsModal">
    See Reviews
  </button>

  <!-- Restaurant Header Info -->
  <div class="row mb-4 animated-fade-in">
    <div class="col-md-4 animated-slide-up">
      <img src="{{ restaurant.image.url }}" class="img-fluid rounded shadow-sm" alt="Restaurant Photo">
    </div>
    <div class="col-md-8 animated-slide-up">
      <div class="d-flex align-items-center">
        <h1 class="mb-3 mr-3">{{ restaurant.name }}</h1>
        <!-- Star Rating for Restaurant -->
        <form class="star-rating" method="POST" action="{% url 'add_restaurant_review' restaurant.restaurant_id %}">
          {% csrf_token %}
          <input type="radio" id="star5" name="rating" value="5" />
          <label for="star5" title="5 stars">★</label>
          <input type="radio" id="star4" name="rating" value="4" />
          <label for="star4" title="4 stars">★</label>
          <input type="radio" id="star3" name="rating" value="3" />
          <label for="star3" title="3 stars">★</label>
          <input type="radio" id="star2" name="rating" value="2" />
          <label for="star2" title="2 stars">★</label>
          <input type="radio" id="star1" name="rating" value="1" />
          <label for="star1" title="1 star">★</label>
          <button type="submit" class="btn btn-link p-0 ml-2">Submit</button>
        </form>
      </div>
      <p><strong>Address:</strong> {{ restaurant.address }}</p>
      <p><strong>Phone:</strong> {{ restaurant.phone }}</p>
      <p><strong>Delivery Charge:</strong> ${{ restaurant.delivery_charge }}</p>
      <p><strong>Minimum Order:</strong> ${{ restaurant.min_order }}</p>
      <p><strong>Open Until:</strong> {{ restaurant.open_until }}</p>
      <button class="btn btn-outline-info mt-3" data-toggle="modal" data-target="#restaurantMoreInfoModal">
        More Info
      </button>
    </div>
  </div>

  <!-- More Info Modal -->
  <div class="modal fade" id="restaurantMoreInfoModal" tabindex="-1" role="dialog" aria-labelledby="moreInfoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ restaurant.name }} - More Info</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p><strong>Address:</strong> {{ restaurant.address }}</p>
          <p><strong>Open Until:</strong> {{ restaurant.open_until }}</p>
          <p><strong>Weekly Schedule:</strong></p>
          <ul>
            <li>Monday: 10:00 AM - 10:00 PM</li>
            <li>Tuesday: 10:00 AM - 10:00 PM</li>
            <li>Wednesday: 10:00 AM - 10:00 PM</li>
            <li>Thursday: 10:00 AM - 10:00 PM</li>
            <li>Friday: 10:00 AM - 11:00 PM</li>
            <li>Saturday: 10:00 AM - 11:00 PM</li>
            <li>Sunday: Closed</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Menu Section -->
  <h2 class="mb-4 animated-fade-in">Menu</h2>

  <!-- Search Bar -->
  <form method="GET" class="form-inline mb-4 animated-slide-up">
    <input type="text" name="q" class="form-control mr-2 flex-grow-1" placeholder="Search for food..." value="{{ request.GET.q }}">
    <button type="submit" class="btn btn-secondary">Search</button>
  </form>

  <!-- Food Items -->
  <div class="row">
    {% for item in food_items %}
    <div class="col-md-6 mb-4">
      <div class="card h-100 shadow-sm border-0 rounded animated-fade-in">
        <div class="row no-gutters">
          <div class="col-md-4">
            <img src="{{ item.image.url }}" class="card-img rounded-start" alt="{{ item.name }}">
          </div>
          <div class="col-md-8">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ item.name }}</h5>
              <p class="card-text flex-grow-1">{{ item.description|truncatechars:100 }}</p>
              <p><strong>Price:</strong> ${{ item.price }}</p>
              <!-- Form for selecting quantity -->
              <form method="POST" action="{% url 'add_to_cart' item.food_id %}">
                {% csrf_token %}
                <div class="form-group mb-2">
                  <label for="quantity_{{ forloop.counter }}">Quantity:</label>
                  <input type="number" name="quantity" id="quantity_{{ forloop.counter }}" class="form-control" value="1" min="1">
                </div>
                <button type="submit" class="btn btn-primary w-100">Add to Cart</button>
              </form>
              <!-- Star Rating for Food Item -->
              <form class="star-rating mt-2" method="POST" action="{% url 'add_food_item_review' item.food_id %}">
                {% csrf_token %}
                <input type="radio" id="star5-{{ item.food_id }}" name="rating" value="5" />
                <label for="star5-{{ item.food_id }}" title="5 stars">★</label>
                <input type="radio" id="star4-{{ item.food_id }}" name="rating" value="4" />
                <label for="star4-{{ item.food_id }}" title="4 stars">★</label>
                <input type="radio" id="star3-{{ item.food_id }}" name="rating" value="3" />
                <label for="star3-{{ item.food_id }}" title="3 stars">★</label>
                <input type="radio" id="star2-{{ item.food_id }}" name="rating" value="2" />
                <label for="star2-{{ item.food_id }}" title="2 stars">★</label>
                <input type="radio" id="star1-{{ item.food_id }}" name="rating" value="1" />
                <label for="star1-{{ item.food_id }}" title="1 star">★</label>
                <button type="submit" class="btn btn-link p-0 ml-2">Submit</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <p class="animated-fade-in">No food items available in this restaurant.</p>
    {% endfor %}
  </div>
</div>

<!-- Reviews Modal -->
<div class="modal fade" id="reviewsModal" tabindex="-1" role="dialog" aria-labelledby="reviewsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewsModalLabel">Reviews</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="reviewsContainer">
        {% for review in food_item_reviews %}
        <div class="review">
          <div class="review-header">
            <div class="review-rating">
              {% for i in "12345" %}
                {% if forloop.counter <= review.rating %}
                  <span class="star">★</span>
                {% else %}
                  <span class="star">☆</span>
                {% endif %}
              {% endfor %}
            </div>
            <div class="review-author">{{ review.user.username }}</div>
            <div class="review-date">{{ review.created_at|date:"F j, Y" }}</div>
          </div>
          <div class="review-text">
            {{ review.review_text }}
          </div>
          <div class="review-actions">
            <a href="#">Reply</a>
            <a href="#">♥ 0</a>
          </div>
        </div>
        {% empty %}
        <p>No reviews yet.</p>
        {% endfor %}
      </div>
      <div class="modal-footer">
        <!-- Rating selector -->
        <select id="reviewRating" class="form-control" style="width: 15%; margin-right: 5px;">
          <option value="5" selected>5★</option>
          <option value="4">4★</option>
          <option value="3">3★</option>
          <option value="2">2★</option>
          <option value="1">1★</option>
        </select>

        <!-- Display selected rating -->
        <span id="selectedRatingDisplay" style="margin-right: 10px;">Selected Rating: 5★</span>

        <!-- Input box for new review -->
        <input type="text" id="newReviewText" class="form-control" placeholder="Write your review here" style="width: 60%; margin-right: 10px; display: inline-block;" />

        <!-- Submit Review button -->
        <button type="button" class="btn btn-primary" id="submitReviewBtn">Submit Review</button>

        <!-- Close button -->
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Update selected rating display when dropdown changes
  document.getElementById('reviewRating').addEventListener('change', function() {
    const selectedRating = this.value;
    document.getElementById('selectedRatingDisplay').textContent = `Selected Rating: ${selectedRating}★`;
  });

  // When Submit Review button is clicked
  document.getElementById('submitReviewBtn').addEventListener('click', function() {
    const reviewTextInput = document.getElementById('newReviewText');
    const reviewText = reviewTextInput.value.trim();
    if (!reviewText) {
      alert('Please write a review before submitting.');
      return;
    }

    const selectedRating = document.getElementById('reviewRating').value;

    // Create new review HTML element
    const reviewDiv = document.createElement('div');
    reviewDiv.classList.add('review');

    // Create star rating based on selected rating
    let starRating = '';
    for (let i = 1; i <= 5; i++) {
      if (i <= selectedRating) {
        starRating += '<span class="star">★</span>';
      } else {
        starRating += '<span class="star">☆</span>';
      }
    }

    // Set the HTML content for the new review
    reviewDiv.innerHTML = `
      <div class="review-header">
        <div class="review-rating">
          ${starRating}
        </div>
        <div class="review-author">You</div>
        <div class="review-date">${new Date().toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}</div>
      </div>
      <div class="review-text">${reviewText}</div>
      <div class="review-actions">
        <a href="#">Reply</a>
        <a href="#">♥ 0</a>
      </div>
    `;

    // Append new review to the reviews container
    const reviewsContainer = document.getElementById('reviewsContainer');

    // If "No reviews yet." message exists, remove it
    const emptyMsg = reviewsContainer.querySelector('p');
    if (emptyMsg && emptyMsg.textContent.trim() === 'No reviews yet.') {
      emptyMsg.remove();
    }

    reviewsContainer.appendChild(reviewDiv);

    // Clear the input box
    reviewTextInput.value = '';
  });
</script>

{% endblock %}
